---
alwaysApply: true
---
# Cursor Rules: Vite + React + PWA

## Project Overview
This project uses **Vite + React + TypeScript** for a Progressive Web App (PWA) that runs entirely in the browser with static hosting compatibility.

## Core Stack
- **Build Tool**: Vite (latest stable)
- **Framework**: React 18+ with TypeScript
- **Routing**: React Router with HashRouter (for static hosting)
- **PWA**: vite-plugin-pwa with Workbox
- **Storage**: localStorage (browser-only, no backend)
- **Deployment**: Static hosting (Netlify, Vercel, GitHub Pages, Cloudflare Pages, etc.)

## Project Structure

```
src/
├── components/          # Reusable UI components
│   ├── ui/             # Basic UI primitives (buttons, inputs, etc.)
│   └── layout/         # Layout components (header, footer, etc.)
├── pages/              # Page-level components (routes)
├── hooks/              # Custom React hooks
├── utils/              # Utility functions and helpers
├── types/              # TypeScript type definitions
├── stores/             # State management (if using Zustand/Jotai)
├── styles/             # Global styles and CSS variables
├── assets/             # Static assets (images, icons)
├── App.tsx             # Root component with routing
├── main.tsx            # Entry point
└── vite-env.d.ts       # Vite type definitions

public/
├── icons/              # PWA icons (192x192, 512x512)
├── manifest.json       # PWA manifest (auto-generated by plugin)
└── index.html          # HTML template
```

## Vite Configuration Best Practices

### Required Plugins
- `@vitejs/plugin-react` - React support with Fast Refresh
- `vite-plugin-pwa` - PWA capabilities with Workbox
- Use `defineConfig` for TypeScript support

### Build Configuration
```typescript
// vite.config.ts
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'
import { VitePWA } from 'vite-plugin-pwa'

export default defineConfig({
  plugins: [
    react(),
    VitePWA({
      registerType: 'autoUpdate',
      includeAssets: ['favicon.ico', 'apple-touch-icon.png', 'mask-icon.svg'],
      manifest: {
        name: 'App Name',
        short_name: 'App',
        description: 'App description',
        theme_color: '#ffffff',
        background_color: '#ffffff',
        display: 'standalone',
        icons: [
          { src: 'icons/icon-192x192.png', sizes: '192x192', type: 'image/png' },
          { src: 'icons/icon-512x512.png', sizes: '512x512', type: 'image/png' },
        ],
      },
      workbox: {
        globPatterns: ['**/*.{js,css,html,ico,png,svg,woff2}'],
        runtimeCaching: [
          {
            urlPattern: /^https:\/\/fonts\.googleapis\.com\/.*/i,
            handler: 'CacheFirst',
            options: {
              cacheName: 'google-fonts-cache',
              expiration: { maxEntries: 10, maxAgeSeconds: 60 * 60 * 24 * 365 },
            },
          },
        ],
      },
    }),
  ],
  build: {
    outDir: 'dist',
    sourcemap: false, // Disable in production for smaller bundles
    rollupOptions: {
      output: {
        manualChunks: {
          vendor: ['react', 'react-dom', 'react-router-dom'],
        },
      },
    },
  },
  server: {
    port: 3000,
    open: true,
  },
})
```

### Environment Variables
- Use `.env.local` for local development secrets
- Prefix public variables with `VITE_`
- Never commit `.env.local` to git
- Access via `import.meta.env.VITE_*`

## React Best Practices

### Component Structure
- Use **functional components** with hooks exclusively
- Prefer **named exports** for components
- Keep components **small and focused** (single responsibility)
- Extract reusable logic into **custom hooks**

### Component Template
```typescript
import { useState, useEffect } from 'react'
import type { FC } from 'react'

interface ComponentProps {
  // Props interface
}

export const Component: FC<ComponentProps> = ({ prop1, prop2 }) => {
  // Hooks first
  const [state, setState] = useState<Type>(initialValue)
  
  // Effects
  useEffect(() => {
    // Effect logic
  }, [dependencies])
  
  // Event handlers
  const handleClick = () => {
    // Handler logic
  }
  
  // Early returns for conditional rendering
  if (condition) return <Fallback />
  
  // Render
  return (
    <div>
      {/* JSX */}
    </div>
  )
}
```

### State Management
- **localState**: Use `useState` for component-local state
- **Shared State**: Use `useContext` or Zustand/Jotai for simple apps
- **Server State**: Not applicable (browser-only app)
- **localStorage**: Create custom hooks for persistence

### Custom Hooks Pattern
```typescript
// hooks/useLocalStorage.ts
import { useState, useEffect } from 'react'

export function useLocalStorage<T>(key: string, initialValue: T) {
  const [storedValue, setStoredValue] = useState<T>(() => {
    try {
      const item = window.localStorage.getItem(key)
      return item ? JSON.parse(item) : initialValue
    } catch (error) {
      console.error(`Error reading localStorage key "${key}":`, error)
      return initialValue
    }
  })

  const setValue = (value: T | ((val: T) => T)) => {
    try {
      const valueToStore = value instanceof Function ? value(storedValue) : value
      setStoredValue(valueToStore)
      window.localStorage.setItem(key, JSON.stringify(valueToStore))
    } catch (error) {
      console.error(`Error setting localStorage key "${key}":`, error)
    }
  }

  return [storedValue, setValue] as const
}
```

### Performance Optimization
- **Code Splitting**: Use `React.lazy()` and `Suspense` for route-based splitting
- **Memoization**: Use `React.memo()` for expensive components, `useMemo()` for expensive calculations, `useCallback()` for stable function references
- **Virtualization**: Use `react-window` or `react-virtuoso` for long lists
- **Image Optimization**: Use `loading="lazy"` and modern formats (WebP, AVIF)

### React Router Setup
```typescript
// App.tsx
import { HashRouter, Routes, Route } from 'react-router-dom'

export function App() {
  return (
    <HashRouter>
      <Routes>
        <Route path="/" element={<HomePage />} />
        <Route path="/about" element={<AboutPage />} />
      </Routes>
    </HashRouter>
  )
}
```

## TypeScript Best Practices

### Type Definitions
- Define **interfaces** for component props and data structures
- Use **type aliases** for unions and complex types
- Prefer **interfaces** over types for object shapes (extensibility)
- Use **const assertions** (`as const`) for literal types

### Strict Configuration
```json
// tsconfig.json
{
  "compilerOptions": {
    "target": "ES2020",
    "useDefineForClassFields": true,
    "lib": ["ES2020", "DOM", "DOM.Iterable"],
    "module": "ESNext",
    "skipLibCheck": true,
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "resolveJsonModule": true,
    "isolatedModules": true,
    "noEmit": true,
    "jsx": "react-jsx",
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "noFallthroughCasesInSwitch": true,
    "forceConsistentCasingInFileNames": true
  }
}
```

### Type Safety Patterns
```typescript
// Prefer discriminated unions for state
type LoadingState = 
  | { status: 'idle' }
  | { status: 'loading' }
  | { status: 'success'; data: Data }
  | { status: 'error'; error: Error }

// Use type guards for runtime checks
function isError(value: unknown): value is Error {
  return value instanceof Error
}
```

## PWA Best Practices

### Service Worker Strategy
- **Precache**: Static assets (HTML, CSS, JS, images)
- **Cache First**: Static assets that rarely change
- **Network First**: Dynamic content (if applicable)
- **Stale While Revalidate**: For frequently updated content

### Offline Support
- Provide **offline fallback page** (`offline.html`)
- Show **offline indicator** when network is unavailable
- Handle **localStorage errors** gracefully (quota exceeded, private browsing)

### Manifest Requirements
- **name** and **short_name** (required)
- **icons** (at least 192x192 and 512x512)
- **theme_color** and **background_color**
- **display**: 'standalone' or 'minimal-ui'
- **start_url**: Should be '/#/' for HashRouter

## Styling Best Practices

### CSS Approach
- Use **CSS Modules** or **CSS-in-JS** (styled-components, emotion) for component styles
- Prefer **CSS Variables** for theming (light/dark mode)
- Use **LCH color space** for perceptual uniformity when specified
- Maintain **WCAG AA contrast** minimum

### CSS Variables Pattern
```css
:root {
  --color-primary: lch(60% 50 200);
  --color-background: lch(98% 2 200);
  --color-text: lch(20% 5 200);
  --spacing-unit: 8px;
  --border-radius: 4px;
}

[data-theme="dark"] {
  --color-background: lch(15% 5 200);
  --color-text: lch(95% 2 200);
}
```

### Responsive Design
- **Mobile-first** approach OR **desktop-first** as specified
- Use **CSS Grid** and **Flexbox** for layouts
- Test on **real devices**, not just browser dev tools
- Use **relative units** (rem, em, %) over fixed pixels where possible

## Code Quality & Consistency

### Naming Conventions
- **Components**: PascalCase (`UserProfile.tsx`)
- **Hooks**: camelCase starting with 'use' (`useLocalStorage.ts`)
- **Utils**: camelCase (`formatDate.ts`)
- **Types/Interfaces**: PascalCase (`UserData.ts`)
- **Constants**: UPPER_SNAKE_CASE (`API_BASE_URL`)

### File Organization
- **One component per file** (unless tightly coupled)
- **Co-locate** related files (component + styles + tests)
- **Barrel exports** (`index.ts`) for clean imports
- **Group by feature** when app grows, not by file type

### Import Order
```typescript
// 1. External dependencies
import React from 'react'
import { useState } from 'react'

// 2. Internal absolute imports
import { Button } from '@/components/ui/Button'
import { useLocalStorage } from '@/hooks/useLocalStorage'

// 3. Relative imports
import { helper } from './utils'

// 4. Types (if needed)
import type { User } from '@/types'
```

### Code Comments
- **Explain WHY**, not WHAT (code should be self-documenting)
- Use **JSDoc** for public APIs and complex functions
- Remove **commented-out code** before committing
- Use **TODO comments** sparingly and include context

## Performance Guidelines

### Bundle Size
- Keep **initial bundle < 200KB** (gzipped)
- Use **dynamic imports** for heavy dependencies
- **Tree-shake** unused code (avoid default imports from large libraries)
- **Analyze bundle** with `vite-bundle-visualizer`

### Runtime Performance
- **Avoid unnecessary re-renders** (use React DevTools Profiler)
- **Debounce/throttle** expensive operations (scroll, resize, input)
- **Virtualize** long lists (100+ items)
- **Lazy load** images below the fold

### Lighthouse Targets
- **Performance**: 90+
- **Accessibility**: 100
- **Best Practices**: 100
- **SEO**: 90+ (if applicable)
- **PWA**: All checks passing

## Accessibility (a11y)

### Requirements
- **Semantic HTML** (use `<button>`, `<nav>`, `<main>`, etc.)
- **ARIA labels** when semantic HTML isn't sufficient
- **Keyboard navigation** (Tab, Enter, Escape, Arrow keys)
- **Focus management** (visible focus indicators, logical tab order)
- **Screen reader support** (test with NVDA/JAWS/VoiceOver)

### Color Contrast
- **WCAG AA minimum**: 4.5:1 for normal text, 3:1 for large text
- **Don't rely on color alone** to convey information
- **Test in both light and dark themes**

### Patterns
```typescript
// Accessible button
<button
  type="button"
  aria-label="Close dialog"
  onClick={handleClose}
>
  <CloseIcon aria-hidden="true" />
</button>

// Accessible form
<label htmlFor="mood-input">
  Select your mood
  <input
    id="mood-input"
    type="range"
    min="1"
    max="5"
    aria-describedby="mood-help"
  />
</label>
<span id="mood-help">Choose a value between 1 and 5</span>
```

## Error Handling

### Error Boundaries
```typescript
import { ErrorBoundary } from 'react-error-boundary'

function ErrorFallback({ error, resetErrorBoundary }) {
  return (
    <div role="alert">
      <h2>Something went wrong:</h2>
      <pre>{error.message}</pre>
      <button onClick={resetErrorBoundary}>Try again</button>
    </div>
  )
}

// Usage
<ErrorBoundary FallbackComponent={ErrorFallback}>
  <App />
</ErrorBoundary>
```

### localStorage Error Handling
```typescript
function safeLocalStorageGet(key: string): string | null {
  try {
    return localStorage.getItem(key)
  } catch (error) {
    // Handle quota exceeded or private browsing mode
    console.warn('localStorage access failed:', error)
    return null
  }
}
```

## Testing Strategy

### Unit Tests
- Test **utilities and hooks** (not implementation details)
- Use **React Testing Library** for component tests
- Test **user behavior**, not component internals
- Aim for **>80% coverage** on critical paths

### E2E Tests (Optional)
- Use **Playwright** or **Cypress** for critical user flows
- Test **offline functionality**
- Test **PWA installation** flow

## Git & Version Control

### Commit Messages
- Use **Conventional Commits** format
- Examples: `feat: add mood logging`, `fix: localStorage quota handling`, `refactor: extract useLocalStorage hook`

### Branch Strategy
- `main` - production-ready code
- `develop` - integration branch (if team)
- Feature branches: `feature/mood-grid-view`

## Deployment Checklist

- [ ] Build succeeds without errors (`npm run build`)
- [ ] Lighthouse audit passes (PWA, Performance, Accessibility)
- [ ] Test offline functionality
- [ ] Verify HashRouter works on static host
- [ ] Check manifest.json is generated correctly
- [ ] Test PWA installation on mobile and desktop
- [ ] Verify localStorage persistence works
- [ ] Test export/import functionality (if applicable)
- [ ] Check console for errors/warnings
- [ ] Test in multiple browsers (Chrome, Firefox, Safari, Edge)

## Common Pitfalls to Avoid

1. **Don't** use BrowserRouter with static hosting (use HashRouter)
2. **Don't** store sensitive data in localStorage
3. **Don't** ignore localStorage quota errors
4. **Don't** forget to handle offline state
5. **Don't** use `any` type in TypeScript
6. **Don't** create unnecessary re-renders
7. **Don't** forget to test PWA installation flow
8. **Don't** hardcode API URLs (use env variables)
9. **Don't** commit `.env.local` files
10. **Don't** ignore accessibility requirements

## Additional Resources

- [Vite Documentation](https://vitejs.dev/)
- [React Documentation](https://react.dev/)
- [PWA Guide](https://web.dev/progressive-web-apps/)
- [Workbox Documentation](https://developers.google.com/web/tools/workbox)
- [React Router HashRouter](https://reactrouter.com/en/main/router-components/hash-router)
- [TypeScript Handbook](https://www.typescriptlang.org/docs/)

---

**Remember**: Write code that is **readable**, **maintainable**, and **performant**. When in doubt, prioritize **simplicity** and **user experience**.

